<!doctype html>
<title>Two</title>

<input id="A">
<input id="B">

<script>
  class Subject {
    constructor(v) {
      this.v = v;
      this.listeners = [];
    }

    addListener(listener, target) {
      this.listeners.push([listener, target]);
    }

    emit(e) {
      for (var pair of this.listeners) {
        var listener = pair[0];
        var target = pair[1];

        if (target !== this.v) {
          listener(e, target);
        }
      }
    }
  }

  class ViewModel {
    constructor(el, value = 0) {
      this.el = el;
      this.value = value;
      this.subject = new Subject(this);
      this.silence = false;
    }

    setValue(value) {
      var old = this.value;

      this.value = value;
      this.el.value = value;

      if (!this.silence) {
        this.silence = true;

        this.subject.emit({old});

        this.silence = false;
      }
    }

    addListener(listener, target) {
      this.subject.addListener(listener, target);
    }
  }

  function viewModelFromInputElement(el) {
    var v = new ViewModel(el);

    el.addEventListener('input', e => {
      v.setValue(el.value);
    });

    return v;
  }

  var A = viewModelFromInputElement(document.querySelector('#A'));
  var B = viewModelFromInputElement(document.querySelector('#B'));

  A.addListener((e, target) => {
    target.setValue((3.0 * A.value) | 0);
  }, B);

  B.addListener((e, target) => {
    target.setValue((B.value / 3.0) | 0);
  }, A);

  A.setValue(123);
</script>
